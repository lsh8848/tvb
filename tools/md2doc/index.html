<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown 转 Word</title>
  <!-- 设置 favicon.ico -->
  <link rel="icon" href="https://tvb.zyh520.tk/img/favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      padding: 10px;
    }
    。container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      font-family: 'Consolas', monospace;
      font-size: 14px;
    }
    。buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    button {
      flex: 1 1 calc(33.33% - 20px);
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
    }
    #openFileButton { background-color: #4CAF50; } /* 绿色 */
    #clearButton { background-color: #FF5722; }   /* 橙红色 */
    #removeEmptyLinesButton { background-color: #03A9F4; } /* 蓝色 */
    #convertButton { background-color: #FFC107; } /* 黄色 */
    #copyButton { background-color: #2196F3; }    /* 深蓝色 */
    #downloadButton { background-color: #E91E63; }/* 粉红色 */
    .drop-zone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .drop-zone.dragover {
      border-color: #000;
    }
    #output {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 200px;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    
    /* 表格样式 */
    #output table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
      font-family: Arial, sans-serif;
    }
    
    #output table th,
    #output table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    
    #output table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    
    #output table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    #output table tr:hover {
      background-color: #f5f5f5;
    }
    
    /* 其他样式优化 */
    #output h1, #output h2, #output h3, #output h4, #output h5, #output h6 {
      margin-top: 20px;
      margin-bottom: 10px;
      color: #333;
    }
    
    #output p {
      margin: 10px 0;
      line-height: 1.6;
    }
    
    #output ul, #output ol {
      margin: 10px 0;
      padding-left: 30px;
    }
    
    #output li {
      margin: 5px 0;
    }
    
    #output code {
      background-color: #f4f4f4;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Consolas', monospace;
    }
    
    #output pre {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      overflow-x: auto;
      margin: 15px 0;
    }
    
    #output pre code {
      background: none;
      padding: 0;
    }
    
    .example-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f8ff;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
    }
    
    .example-section h3 {
      margin-top: 0;
      color: #1976D2;
    }
    
    .example-code {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 10px;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align: center;">Markdown 转 Word (优化版)</h1>

    <!-- 输入区域 -->
    <textarea id="markdownInput" placeholder="在这里粘贴 Markdown 内容..."></textarea>

    <!-- 拖拽区域 -->
    <div class="drop-zone" id="dropZone">拖拽 Markdown 文件到这里，或点击选择文件</div>

    <!-- 按键 -->
    <div class="buttons">
      <button id="openFileButton">打开文件</button>
      <button id="clearButton">清空内容</button>
      <button id="removeEmptyLinesButton">删除空行</button>
      <button id="convertButton">转换 Word</button>
      <button id="copyButton">复制内容</button>
      <button id="downloadButton">下载 Word</button>
    </div>

    <!-- 隐藏的文件输入框 -->
    <input type="file" id="fileInput" accept=".md,.txt" style="display: none;">

    <!-- 输出区域 -->
    <div id="output" contenteditable="true">转换后的内容将显示在这里...</div>
    
    <!-- 示例说明 -->
    <div class="example-section">
      <h3>📋 支持的 Markdown 语法</h3>
      <p><strong>表格语法示例：</strong></p>
      <div class="example-code">| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 内容1 | 内容2 | 内容3 |
| 内容4 | 内容5 | 内容6 |</div>
      
      <p><strong>其他支持的语法：</strong></p>
      <ul>
        <li><strong>标题：</strong> # ## ### #### ##### ######</li>
        <li><strong>粗体：</strong> **文本**</li>
        <li><strong>斜体：</strong> *文本*</li>
        <li><strong>无序列表：</strong> - * + (支持嵌套)</li>
        <li><strong>有序列表：</strong> 1. 2. 3. (支持嵌套)</li>
        <li><strong>链接：</strong> [文本](URL)</li>
        <li><strong>行内代码：</strong> `代码`</li>
        <li><strong>代码块：</strong> ```代码```</li>
        <li><strong>分割线：</strong> --- (转换为空行)</li>
        <li><strong>表格：</strong> | 列1 | 列2 | (支持对齐)</li>
      </ul>
    </div>
  </div>

  <!-- 引入 FileSaver.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    const markdownInput = document.getElementById('markdownInput');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const openFileButton = document.getElementById('openFileButton');
    const clearButton = document.getElementById('clearButton');
    const removeEmptyLinesButton = document.getElementById('removeEmptyLinesButton');
    const convertButton = document.getElementById('convertButton');
    const copyButton = document.getElementById('copyButton');
    const downloadButton = document.getElementById('downloadButton');
    const output = document.getElementById('output');

    // 处理文件上传
    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        markdownInput.value = e.target.result;
        // 自动转换
        convertMarkdown();
      };
      reader.readAsText(file);
    }

    // 拖拽功能
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    dropZone.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    openFileButton.addEventListener('click', () => {
      fileInput.click();
    });

    // 清空内容
    clearButton.addEventListener('click', () => {
      markdownInput.value = '';
      output.innerHTML = '转换后的内容将显示在这里...';
    });

    // 删除空白行（针对输入框中的 Markdown 文本）
    removeEmptyLinesButton.addEventListener('click', () => {
      markdownInput.value = markdownInput.value.replace(/^\s*[\r\n]/gm, '');
    });

    // 处理表格的函数
    function parseTable(text) {
      const lines = text.split('\n');
      let result = '';
      let i = 0;
      
      while (i < lines.length) {
        const line = lines[i].trim();
        
        // 检查是否是表格行（包含 | 符号）
        if (line.includes('|') && line.length > 0) {
          let tableHtml = '<table>';
          let isFirstRow = true;
          
          // 处理表格行
          while (i < lines.length && lines[i].trim().includes('|')) {
            const currentLine = lines[i].trim();
            
            // 跳过分隔行（如 |-----|-----|）
            if (/^\|[\s\-\|:]*\|?$/.test(currentLine)) {
              i++;
              continue;
            }
            
            // 解析表格单元格
            const cells = currentLine.split('|')
              .map(cell => cell.trim())
              .filter((cell, index, array) => {
                // 移除开头和结尾的空单元格
                return !(index === 0 && cell === '') && !(index === array.length - 1 && cell === '');
              });
            
            if (cells.length > 0) {
              const tag = isFirstRow ? 'th' : 'td';
              tableHtml += '<tr>';
              
              cells.forEach(cell => {
                // 处理单元格内的 Markdown 语法
                let processedCell = cell;
                processedCell = processedCell.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                processedCell = processedCell.replace(/\*(.*?)\*/g, '<i>$1</i>');
                processedCell = processedCell.replace(/`([^`]+)`/g, '<code>$1</code>');
                processedCell = processedCell.replace(/\[(.*?)\]\((.*?)\)/g, "<a href='$2'>$1</a>");
                
                tableHtml += `<${tag}>${processedCell}</${tag}>`;
              });
              
              tableHtml += '</tr>';
              isFirstRow = false;
            }
            
            i++;
          }
          
          tableHtml += '</table>';
          result += tableHtml + '\n';
        } else {
          result += lines[i] + '\n';
          i++;
        }
      }
      
      return result;
    }

    // 增强版 Markdown 转 HTML 函数（添加表格支持）
    function markdownToHtml(markdown) {
      // 首先处理表格
      markdown = parseTable(markdown);
      
      // 首先处理长划线 --- 转换为空行
      markdown = markdown.replace(/^---+$/gim, '<br>');
      
      // 转换标题
      markdown = markdown.replace(/^###### (.*$)/gim, '<h6>$1</h6>');
      markdown = markdown.replace(/^##### (.*$)/gim, '<h5>$1</h5>');
      markdown = markdown.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
      markdown = markdown.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      markdown = markdown.replace(/^## (.*$)/gim, '<h2>$1</h2>');
      markdown = markdown.replace(/^# (.*$)/gim, '<h1>$1</h1>');
      
      // 粗体
      markdown = markdown.replace(/\*\*(.*?)\*\*/gim, '<b>$1</b>');
      
      // 斜体
      markdown = markdown.replace(/\*(.*?)\*/gim, '<i>$1</i>');
      
      // 链接
      markdown = markdown.replace(/\[(.*?)\]\((.*?)\)/gim, "<a href='$2'>$1</a>");
      
      // 行内代码
      markdown = markdown.replace(/`([^`]+)`/gim, '<code>$1</code>');
      
      // 多行代码块 ```...```
      markdown = markdown.replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>');
      
      // 处理列表(支持缩进和不同符号)
      markdown = parseLists(markdown);
      
      // 段落 (排除已经被处理的标签)
      markdown = markdown.replace(/^(?!<[hlu\/]|<br>|<pre>|<table)(\S.*?)$/gim, '<p>$1</p>');
      
      return markdown;
    }

    // 增强版列表处理函数 - 支持无序列表的 -, *, + 和有序列表
    function parseLists(text) {
      const lines = text.split('\n');
      let result = '';
      const stack = []; // 保存缩进级别对应的列表类型和标签
      
      lines.forEach(line => {
        // 匹配无序列表: -, *, +
        const unorderedMatch = /^(\s*)[-*+] (.*)/.exec(line);
        // 匹配有序列表: 1. 2. 3. 等
        const orderedMatch = /^(\s*)(\d+)\. (.*)/.exec(line);
        
        if (unorderedMatch || orderedMatch) {
          const isOrdered = !!orderedMatch;
          const match = unorderedMatch || orderedMatch;
          const indent = match[1].length; // 缩进空格数
          const content = isOrdered ? match[3].trim() : match[2].trim();
          
          // 当前缩进层级 (约定 2-4 空格 = 1 层)
          let level = Math.floor(indent / 2);
          
          // 如果需要进入更深层次
          while (stack.length <= level) {
            const listType = isOrdered ? 'ol' : 'ul';
            result += `<${listType}>`;
            stack.push(listType);
          }
          
          // 如果回退层级
          while (stack.length > level + 1) {
            const listType = stack.pop();
            result += `</${listType}>`;
          }
          
          // 如果当前层级的列表类型不匹配，需要关闭并重新开启
          if (stack.length > 0) {
            const currentType = isOrdered ? 'ol' : 'ul';
            if (stack[stack.length - 1] !== currentType) {
              const oldType = stack.pop();
              result += `</${oldType}>`;
              result += `<${currentType}>`;
              stack.push(currentType);
            }
          }
          
          result += `<li>${content}</li>`;
        } else {
          // 关闭所有未闭合的列表
          while (stack.length > 0) {
            const listType = stack.pop();
            result += `</${listType}>`;
          }
          result += line + '\n';
        }
      });
      
      // 关闭所有未闭合的列表
      while (stack.length > 0) {
        const listType = stack.pop();
        result += `</${listType}>`;
      }
      
      return result;
    }

    // 转换函数
    function convertMarkdown() {
      const markdown = markdownInput.value;
      const htmlContent = markdownToHtml(markdown);
      output.innerHTML = htmlContent;
    }
    
    // 转换按钮
    convertButton.addEventListener('click', convertMarkdown);

    // 实时转换功能
    markdownInput.addEventListener('input', convertMarkdown);

    // 复制按钮
    copyButton.addEventListener('click', () => {
      const range = document.createRange();
      range.selectNodeContents(output);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand('copy');
      selection.removeAllRanges();
      alert('已复制转换后的内容到剪贴板！');
    });

    // 下载为 Word 文件
    downloadButton.addEventListener('click', () => {
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>文档</title>
          <style>
            @page {
              margin: 2.54cm 2.54cm 2.54cm 2.54cm;
            }
            body { 
              font-family: "Times New Roman", serif; 
              line-height: 1.6; 
              margin: 0; 
              padding: 0;
              width: 100%;
            }
            h1, h2, h3, h4, h5, h6 { margin-top: 20px; margin-bottom: 10px; font-weight: bold; }
            p { margin: 10px 0; }
            ul, ol { margin: 10px 0; padding-left: 30px; }
            li { margin: 5px 0; }
            table { 
              border-collapse: collapse; 
              width: 100%; 
              margin: 15px 0; 
              table-layout: fixed;
            }
            th, td { 
              border: 1px solid #000; 
              padding: 8px; 
              text-align: left; 
              word-wrap: break-word;
              vertical-align: top;
            }
            th { background-color: #f2f2f2; font-weight: bold; }
            code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
            pre { 
              background-color: #f8f8f8; 
              border: 1px solid #ddd; 
              padding: 10px; 
              margin: 15px 0;
              white-space: pre-wrap;
              word-wrap: break-word;
            }
            pre code { background: none; padding: 0; }
            a { color: #0066cc; text-decoration: underline; }
            b { font-weight: bold; }
            i { font-style: italic; }
            
            /* Word 特定样式 */
            * {
              box-sizing: border-box;
            }
            
            /* 确保内容不会溢出页面 */
            div, p, table, pre {
              max-width: 100%;
            }
          </style>
        </head>
        <body>
          ${output.innerHTML}
        </body>
        </html>
      `;
      const blob = new Blob([htmlContent], { type: 'application/msword' });
      saveAs(blob, '文档.doc');
    });

    // 页面加载时自动转换示例
    window.addEventListener('load', () => {
      convertMarkdown();
    });
  </script>
</body>
</html>
